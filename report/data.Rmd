# Data

```{r, echo = FALSE, message = FALSE}
source(here::here("scripts/setup.R"))
```

* Sources
* Description
* Wrangling/cleaning
* Spotting mistakes and missing data (could be part of EDA too)
* Listing anomalies and outliers (could be part of EDA too)

For our research, we used three different datasets. While searching for datasets, we made sure that the years and countries matched for every one of them.

## Wrangling and cleaning

### Caloric consumption


The first is the dataset with information related to caloric consumption. We downloaded it from the portal https://ourworldindata.org/diet-compositions. It is composed of many information related to caloric consumption for almost all countries in the world. It gives us information on the average nutrition of different countries from 1961 to 2013, and we have information about: 

```{r}
daily_caloric <- read_csv(here::here("data/daily-caloric.csv"))
```

* We only wanted to focus on observations from European countries with Switzerland and the UK in the 2000s, which is why we have sorted the data as follows:

```{r}
daily_caloric <- subset(daily_caloric, Year >= 2000)
EU <- c("AUT", "BEL", "BGR", "HRV", "CYP", "CZE", "DNK", "EST", "FIN", "FRA", "DEU", "GRC", "HUN", "IRL", "ITA", "LVA", "LTU", "LUX", "MLT", "NLD", "POL", "PRT", "ROU", "SVK", "SVN", "ESP", "SWE", "GBR", "CHE")
daily_caloric<-daily_caloric[daily_caloric$Code %in% EU,]
daily_caloric
```

* We used the ISO code as it is standardized worldwide and does not have the risk of having different names in different tables like the countries' names.

* We then focused on these variables:

  `Entity` Name of the country  
  `Code` ISO country code  
  `Calories from animal protein (FAO (2017))` The average per capita supply of calories derived from animal protein    all measured in kilocalories per person per day  
  `Calories from plant protein (FAO (2017))` The average per capita supply of calories derived from plant protein,     all measured in kilocalories per person per day  
  `Calories from fat (FAO (2017))`The average per capita supply of calories derived from fat, all measured in kilocalories per person per day  
  `Calories from carbohydrates (FAO (2017))` The average per capita supply of calories derived from carbohydrates, all measured in kilocalories per person per day  
  
* The intake of specific macronutrients (carbohydrates, protein and fats) are derived based on average food composition factors – these factors are derived and presented in the Food and Agriculture Organisation’s (FAO) Food Balance Sheet Handbook (https://www.fao.org/faostat/en/#data).

* We then computed the mean of the consumption for each type of macronutrient in each country between the years 2000 and 2013, and the sum of total calories per person per day for each country in order to answer our second research question.

```{r}
setDT(daily_caloric)[ , Calories_from_animal_protein := mean(`Calories from animal protein (FAO (2017))`), by = "Entity"]
setDT(daily_caloric)[ , Calories_from_plant_protein := mean(`Calories from plant protein (FAO (2017))`), by = "Entity"]
setDT(daily_caloric)[ , Calories_from_carbohydrates := mean(`Calories from carbohydrates (FAO (2017))`), by = "Entity"]
setDT(daily_caloric)[ , Calories_from_fat := mean(`Calories from fat (FAO (2017))`), by = "Entity"]
```

* We then create a new table with the mean and we also add the sum of total calories per person per day for each country in order to get a broader view with the total consumption of calories.

```{r}
Caloric_consumption <- data.table(daily_caloric$Entity,daily_caloric$Code,daily_caloric$Calories_from_animal_protein, daily_caloric$Calories_from_plant_protein,daily_caloric$Calories_from_carbohydrates,daily_caloric$Calories_from_fat)
Caloric_consumption <-Caloric_consumption[!duplicated(Caloric_consumption)]
Caloric_consumption <- Caloric_consumption[,-1] 
colnames(Caloric_consumption) <- c("country_code", "cal_prot_animal", "cal_prot_plant", "cal_carbs","cal_fat")
Caloric_consumption <-Caloric_consumption %>%
  group_by(country_code) %>%
  mutate(
    total_consumption = sum(c(cal_prot_animal,cal_prot_plant,cal_carbs,cal_fat)))
```

* Our assumption was that a county's wealth may fluctuate over the course of 10 years (ex: a dip during the economic crisis of 2008) but an overall mean is sufficient to compare the different countries and their riches.

* With these new numbers, we created a dataframe and named the columns accordingly:

  `country_code` ISO country code  
  `cal_prot_animal`The mean of the calories from animal protein consumed in each country in the years 2000-2013  
  `cal_prot_plant` The mean of the calories from plant protein consumed in each country in the years 2000-2013  
  `cal_carbs`The mean of the calories from carbohydrates consumed in each country in the years 2000-2013  
  `cal_fat` The mean of the calories from fat consumed in each country in the years 2000-2013  
  `total_consumption` The total consumption based on the means of the consumption of each type of macronutrients in    each countries in the years 2000-2013  
  


### GDP


Our second dataset, downloaded from the portal https://data.worldbank.org, gives us information about the GDP of many countries over the course of 60 years (1960-2020).

```{r}
GDP <- read_excel(here::here("data/GDP(1960-2020).xls"))
```

* It is composed of 266 observations of 65 variables :

`Country Name` Name of the country  
`Country Code` ISO country code  
`Indicator Name` equal to "GDP in current US$" for every row  
`Indicator Code` equal to "NY.GDP.MKTP.CD" for every row  
And a variable for each year from 1960 to 2020  

* As we can see below, RStudio imported the Excel file as is, and so our column names found themselves at the 3rd row and therefore column names of columns 3 to 65 have been attributed numbers.

```{r}
GDP
```

* We decided to fix that and to filter out the years that is in our interest and that we have in common with other tables, AKA the years 2000-2013. We decided to get rid of the 'Indicator Name' and 'Indicator Code' variables as well since the values are the same for every row and they do not provide additional useful information.

```{r}
colnames(GDP) <- GDP[3,]
GDP <- GDP[-c(1:3),-c(3:44,59:65)]
```

* Now, we want to filter out the European countries, just like in the first table :

```{r}
GDP <- GDP[GDP$"Country Code" %in% EU,]
```

* In order to join tables easily, we transformed the columns corresponding to different years to a single “year” column, in order to have at each row of this dataset the GDP of a certain country at a certain year.

```{r}
GDP <- GDP %>% pivot_longer(c('2000','2001','2002','2003','2004','2005','2006','2007','2008','2009','2010','2011','2012','2013'),names_to = "Year",values_to = "Gross Domestic Product")
```

* To make it easier to manipulate data, we decided to rename our variables for this table as well. We also made sure that the type of our numeric variable (GDP) was numeric and not character, like it was by default.

```{r}
colnames(GDP) <- c("country_name","country_code","year","avg_gdp")
GDP$avg_gdp <- as.numeric(GDP$avg_gdp)
```

* Lastly, we computed the average GDP for each country over the years 2000-2013 in order to be able to plot different variables together.

```{r}
GDP <- GDP %>% 
  group_by(country_name, country_code) %>% 
  summarize(avg_gdp = mean(avg_gdp))
GDP %>%

  #label_number("avg_gdp",accuracy = T,scale=1,prefix = "$", suffix = "M")
   #unit_format(unit = "$Millions", scale = 1e-10)(c("avg_gdp"))
   #mutate_at(c(3), funs(c(scale(.)))) #this scaling method doesn't work, how to do it ?
  
library(dplyr)
library(gt)

mtcars %>%
  group_by(cyl)%>%
  summarise(Transaction_count = n() * 100, mpg = sum(mpg)) %>%
  mutate(Count_contribution = Transaction_count/sum(Transaction_count)) %>%
  gt() %>%
  fmt_percent(columns = Count_contribution,decimals = 1) %>%
  fmt_number(columns = Transaction_count)

GDP <-
  exibble %>%
  gt() %>%
  fmt_number(
  GDP$avg_gdp,
  rows = everything(),
  decimals = 4,
  n_sigfig = NULL,
  drop_trailing_zeros = FALSE,
  drop_trailing_dec_mark = TRUE,
  use_seps = TRUE,
  accounting = FALSE,
  scale_by = 1/(exp(11)),
  suffixing = F)
```

* We now have a dataframe with the following variables :

`country_name` name of the country  
`country_code` ISO code of the country  
`avg_gdp` the average GDP of a country over the course of 2000-2013  


### Diabetes

```{r}
Diabetes <- read_csv(here::here("data/Diabetes.csv"))
```
*keep only data from 2000-2013

```{r}
Diabetes2 <- subset(Diabetes, Year >= 2000 , Year <=2013)
```

* keep only european countries

```{r}
Diabetes_EU<-Diabetes2[Diabetes2$`ISO` %in% EU,]
```
* drop interval and country names

```{r}
Diabetes_EU <- Diabetes_EU[-c(1,6,7)]
```
* separate men and women

```{r}
Diabetes_EU_men <-subset(Diabetes_EU, Sex=="Men")
Diabetes_EU_women <-subset(Diabetes_EU, Sex=="Women")
```
* change colomn name

```{r}
colnames(Diabetes_EU_men)<-c("country_code","sex","year","prop_men_diabetes")
colnames(Diabetes_EU_women)<-c("country_code","sex","year","prop_women_diabetes")
```
* group by country

```{r}
Diabetes_EU_men <- Diabetes_EU_men %>% 
  group_by(country_code) %>%
  summarize(prop_men_diabetes = mean(prop_men_diabetes))
Diabetes_EU_women <- Diabetes_EU_women %>% 
  group_by(country_code) %>%
  summarize(prop_women_diabetes = mean(prop_women_diabetes))
```



## Joining tables

Finally, we joined all three tables in one dataset with the 'country_code' key :

```{r}
GDP_diabetes_cal <-full_join(GDP,Diabetes_EU_men, by="country_code")
GDP_diabetes_cal <-full_join(GDP_diabetes_cal,Diabetes_EU_women, by="country_code")
GDP_diabetes_cal <-full_join(GDP_diabetes_cal ,Caloric_consumption, by="country_code")
```

