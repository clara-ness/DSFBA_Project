# Analysis

```{r, echo = FALSE, message = FALSE}
source(here::here("scripts/setup.R"))
```

* Answers to the research questions
* Different methods considered
* Competing approaches
* Justifications

### 1.Do European countries that have higher GDPs really have lower diabetes prevalence ?

This first question serves more as a control, since we learned during our research prior to our project that countries with higher GDPs tend to have lower diabetes rates. Indeed, we can observe that in the EDA. 

It is important to note that, when we try to fit a linear model on these variables and observe correlations over all observations, we see that these relationships are not significant at all.

```{r}
#with outliers
cor(GDP_diabetes_cal$avg_gdp, GDP_diabetes_cal$prop_women_diabetes)
cor(GDP_diabetes_cal$avg_gdp, GDP_diabetes_cal$prop_men_diabetes)

lm_gdp_diabetes_women <- lm(GDP_diabetes_cal$avg_gdp ~ GDP_diabetes_cal$prop_women_diabetes)

lm_gdp_diabetes_men <- lm(GDP_diabetes_cal$avg_gdp ~ GDP_diabetes_cal$prop_men_diabetes)

kable(prettify(summary(lm_gdp_diabetes_women)))
kable(prettify(summary(lm_gdp_diabetes_men)))
```

However, once we exclude outliers, we see that the relationship is way more significant !

```{r}
#without outliers
cor(GDP_diabetes_cal2$avg_gdp, GDP_diabetes_cal2$prop_women_diabetes)
cor(GDP_diabetes_cal2$avg_gdp, GDP_diabetes_cal2$prop_men_diabetes)

lm_gdp_diabetes_women2 <- lm(GDP_diabetes_cal2$avg_gdp ~ GDP_diabetes_cal2$prop_women_diabetes)

lm_gdp_diabetes_men2 <- lm(GDP_diabetes_cal2$avg_gdp ~ GDP_diabetes_cal2$prop_men_diabetes)

kable(prettify(summary(lm_gdp_diabetes_women2)))
kable(prettify(summary(lm_gdp_diabetes_men2)))
```

In the EDA section, we grouped countries in 3 categories, according to the relationship between the GDP and diabetes rate. Here, we confirmed statistically that a relationship exists between these 2 variables when we remove outliers. This therefore made us think that these countries could be categorized into clusters.

To determine the number of clusters we used the elbow method. This method examines the percentage of variance explained as a function of the number of clusters. It is based on the idea that a number of clusters should be chosen such that the addition of another cluster does not allow for a better modeling of the data. The percentage of variance explained by the clusters is plotted against the number of clusters.

```{r}
data_1 <- GDP_diabetes_cal[,-(1:2),drop=FALSE] 
rownames(data_1) <- c("AUT", "BEL", "BGR", "HRV", "CYP", "CZE", "DNK", "EST", "FIN", "FRA", "DEU","GRC", "HUN", "IRL", "ITA", "LVA", "LTU", "LUX", "MLT", "NLD", "POL", "PRT", "ROU", "SVK", "SVN", "ESP", "SWE", "GBR", "CHE")

fviz_nbclust(data_1, kmeans, method = "wss") +
  geom_vline(xintercept = 3, linetype = 2) + # add line for better visualisation
  labs(subtitle = "Elbow method") # add subtitle

```

We therefore see from the graph above that the optimal number of clusters is 3. The allocation of countries according to their cluster is therefore as follows:

```{r}
model_cluster <- kmeans(data_1, centers = 3, nstart = 10)

Data_cluster <- data.frame(data_1,
  cluster = as.factor(model_cluster$cluster))

countries_cluster_1 <- filter(Data_cluster, cluster == "1") #very rich countries (only 2 : LUX & GBR)
countries_cluster_2 <- filter(Data_cluster, cluster == "2") # less rich countries
countries_cluster_3 <- filter(Data_cluster, cluster == "3") # rich countries

kable(countries_cluster_1)
kable(countries_cluster_2)
kable(countries_cluster_3)
```

**Description and order of clusters**

```{r}
cor(countries_cluster_1$avg_gdp, countries_cluster_1$prop_women_diabetes)
cor(countries_cluster_1$avg_gdp, countries_cluster_1$prop_men_diabetes)
cor(countries_cluster_2$avg_gdp, countries_cluster_2$prop_women_diabetes)
cor(countries_cluster_2$avg_gdp, countries_cluster_2$prop_men_diabetes)
cor(countries_cluster_3$avg_gdp, countries_cluster_3$prop_women_diabetes)
cor(countries_cluster_3$avg_gdp, countries_cluster_3$prop_men_diabetes)

lm_gdp_diabetes_women_clust1 <- lm(countries_cluster_1$avg_gdp ~ countries_cluster_1$prop_women_diabetes)
lm_gdp_diabetes_men_clust1 <- lm(countries_cluster_1$avg_gdp ~ countries_cluster_1$prop_men_diabetes)
lm_gdp_diabetes_women_clust2 <- lm(countries_cluster_2$avg_gdp ~ countries_cluster_2$prop_women_diabetes)
lm_gdp_diabetes_men_clust2 <- lm(countries_cluster_2$avg_gdp ~ countries_cluster_2$prop_men_diabetes)
lm_gdp_diabetes_women_clust3 <- lm(countries_cluster_3$avg_gdp ~ countries_cluster_3$prop_women_diabetes)
lm_gdp_diabetes_men_clust3 <- lm(countries_cluster_3$avg_gdp ~ countries_cluster_3$prop_men_diabetes)

kable(prettify(summary(lm_gdp_diabetes_women_clust1)))
kable(prettify(summary(lm_gdp_diabetes_men_clust1)))
kable(prettify(summary(lm_gdp_diabetes_women_clust2)))
kable(prettify(summary(lm_gdp_diabetes_men_clust2)))
kable(prettify(summary(lm_gdp_diabetes_women_clust3)))
kable(prettify(summary(lm_gdp_diabetes_men_clust3)))
```
Clustering here doesn't necessarily help us answer the research question. We can confirm with the previous statistical test without outliers that overall, the GDP of a country and its diabetes rate are negatively correlated. 

However, the clusters defined above could help us answer our other research questions.

### 2.Do European countries that have higher GDPs consume less calories ?

As mentioned in the first point, countries with a higher GDP tend to have a lower diabetes rate, which could potentially be explained by the consumption of fewer calories.

But is there a real correlation between these two variables ? Let's check :

```{r}
cor(GDP_diabetes_cal$avg_gdp,GDP_diabetes_cal$total_consumption)

lm_gdp_total_cal <- lm(GDP_diabetes_cal$avg_gdp ~ GDP_diabetes_cal$total_consumption)

kable(prettify(summary(lm_gdp_total_cal)))
```

Neither the correlation between these two variables nor the linear regression is significant. However, it would be interesting to look further. First, we can see if using the GDP per person instead of the total makes a difference.

```{r}
ggplot() + 
  geom_point(data = GDP_diabetes_cal, aes(x = gdp_per_person, y = total_consumption), color = "orange") +
  geom_smooth(mapping = aes(x = GDP_diabetes_cal$gdp_per_person, y=GDP_diabetes_cal$total_consumption), color = "orange", method = "lm") +
  labs(x = "GDP per capita", y= "Calories")
```

The plot looks more or less the same as the one in the EDA section without the outliers. But is the relationship with this new variable statistically significant ?

```{r}
cor(GDP_diabetes_cal$gdp_per_person,GDP_diabetes_cal$total_consumption)

lm_gdp_pp_total_cal <- lm(GDP_diabetes_cal$gdp_per_person ~ GDP_diabetes_cal$total_consumption)

kable(prettify(summary(lm_gdp_pp_total_cal)))
```

We see that the correlation is higher now and the significance of the relationship, even though not high enough, increased.

Next we can proceed with a cluster analysis, with the ones defined in the first question.

**insert more analysis**

Oddly enough, it seems that a higher consumption of animal protein could be related to the rate of diabetes, which would be counter-intuitive to M. Adeva-Andany's (2019) article "Dietary habits contribute to define the risk of type 2 diabetes in humans".

We are going to investigate this very issue of calorie consumption patterns that could be related to low diabetes rates. 

```{r}
#trying to plot the consumption patterns
#library(plotly)
#library(dplyr)

#donut<- data.frame(GDP_diabetes_cal , cat=c("cal_prot_animal", "cal_carbs", "cal_prot_plant", "cal_fat"))

#GDP_diabetes_cal$total_consumption <- sapply(strsplit(rownames(GDP_diabetes_cal), " "), "[[", 1)

#donut <- donut %>% group_by(cat)
#donut <- donut %>% summarize(count = n())
#fig <- donut %>% plot_ly(labels = ~cat, values = ~count)
#fig <- fig %>% add_pie(hole = 0.6)
#fig <- fig %>% layout(title = "Donut charts to show consumption patterns",  showlegend = F,
                     # xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
                     # yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

#fig

```



### 3.How do the macronutrients (animal protein/plant protein/fat/carbohydrates) consumed differ between richer and poorer countries ?

We observed during the EDA that richer countries seemed to consume more fat on average. Now we want to see if we can confirm this relationship, and observe if there isn't a correlation between the average GDP of a country and the consumption of other macronutrients too.

```{r}
cor(GDP_diabetes_cal$avg_gdp,GDP_diabetes_cal$cal_prot_animal)
cor(GDP_diabetes_cal$avg_gdp,GDP_diabetes_cal$cal_prot_plant)
cor(GDP_diabetes_cal$avg_gdp,GDP_diabetes_cal$cal_carbs)
cor(GDP_diabetes_cal$avg_gdp,GDP_diabetes_cal$cal_fat)


lm_gdp_cal_prot_animal <- lm(GDP_diabetes_cal$avg_gdp ~ GDP_diabetes_cal$cal_prot_animal)
lm_gdp_cal_prot_plant <- lm(GDP_diabetes_cal$avg_gdp ~ GDP_diabetes_cal$cal_prot_plant)
lm_gdp_cal_carbs <- lm(GDP_diabetes_cal$avg_gdp ~ GDP_diabetes_cal$cal_carbs)
lm_gdp_cal_fat <- lm(GDP_diabetes_cal$avg_gdp ~ GDP_diabetes_cal$cal_fat)

kable(prettify(summary(lm_gdp_cal_prot_animal)))
kable(prettify(summary(lm_gdp_cal_prot_plant)))
kable(prettify(summary(lm_gdp_cal_carbs)))
kable(prettify(summary(lm_gdp_cal_fat)))
```

The relationship between the average GDP of a country and the calories consumed from fat per person is the only macronutriment that is significant. For other macronutriments, there seems to be no correlation at all.

Let's see if considering the GDP per person instead of the total makes a difference.

```{r}
#with GDP per person
ggplot() + 
  geom_point(data = GDP_diabetes_cal, aes(x = gdp_per_person, y = cal_fat), color = "blue") +
  geom_smooth(mapping = aes(x = GDP_diabetes_cal$gdp_per_person, y=GDP_diabetes_cal$cal_fat), color = "blue", method = "lm") +
  labs(x = "GDP per capita", y= "Calories from fat")

ggplot() +
  geom_point(data = GDP_diabetes_cal, aes(x = gdp_per_person, y = cal_carbs), color = "purple") +
  geom_smooth(mapping = aes(x = GDP_diabetes_cal$gdp_per_person, y=GDP_diabetes_cal$cal_carbs), color = "purple", method = "lm") +
  labs(x = "GDP per capita", y= "Calories from carbs")

ggplot() +
  geom_point(data = GDP_diabetes_cal, aes(x = gdp_per_person, y = cal_prot_animal), color = "red") +  
  geom_smooth(mapping = aes(x = GDP_diabetes_cal$gdp_per_person, y=GDP_diabetes_cal$cal_prot_animal), color = "red", method = "lm") +
  labs(x = "GDP per capita", y= "Calories from animal protein")

ggplot() +
  geom_point(data = GDP_diabetes_cal, aes(x = gdp_per_person, y = cal_prot_plant), color = "green") +
  geom_smooth(mapping = aes(x = GDP_diabetes_cal$gdp_per_person, y=GDP_diabetes_cal$cal_prot_plant), color = "green", method = "lm") +
  labs(x = "GDP per capita", y= "Calories from plant protein")
```

Another way to answer this research question can be to see the relationship between the wealth of a country and the proportions of the total calories consumed dedicated to each macronutrient.

```{r}
GDP_diabetes_cal <- mutate(GDP_diabetes_cal, proportion_animal_prot = cal_prot_animal/total_consumption, proportion_plant_prot = cal_prot_plant/total_consumption, proportion_carbs = cal_carbs/total_consumption, proportion_fat = cal_fat/total_consumption)

cor(GDP_diabetes_cal$avg_gdp,GDP_diabetes_cal$proportion_animal_prot)
cor(GDP_diabetes_cal$avg_gdp,GDP_diabetes_cal$proportion_plant_prot)
cor(GDP_diabetes_cal$avg_gdp,GDP_diabetes_cal$proportion_carbs)
cor(GDP_diabetes_cal$avg_gdp,GDP_diabetes_cal$proportion_fat)

lm_gdp_prop_animal_prot <- lm(GDP_diabetes_cal$avg_gdp ~ GDP_diabetes_cal$proportion_animal_prot)
lm_gdp_prop_plant_prot <- lm(GDP_diabetes_cal$avg_gdp ~ GDP_diabetes_cal$proportion_plant_prot)
lm_gdp_prop_carbs <- lm(GDP_diabetes_cal$avg_gdp ~ GDP_diabetes_cal$proportion_carbs)
lm_gdp_prop_fat <- lm(GDP_diabetes_cal$avg_gdp ~ GDP_diabetes_cal$proportion_fat)

kable(prettify(summary(lm_gdp_prop_animal_prot)))
kable(prettify(summary(lm_gdp_prop_plant_prot)))
kable(prettify(summary(lm_gdp_prop_carbs)))
kable(prettify(summary(lm_gdp_prop_fat)))
```

With proportions, correlation is higher than with calorie count and linear regression parameters a bit more significant but the relationships are still not strong enough.

```{r}
#with GDP per person
ggplot() + 
  geom_point(data = GDP_diabetes_cal, aes(x = gdp_per_person, y = proportion_fat), color = "blue") +
  geom_smooth(mapping = aes(x = GDP_diabetes_cal$gdp_per_person, y=GDP_diabetes_cal$proportion_fat), color = "blue", method = "lm") +
  labs(x = "GDP per capita", y= "Calories from fat")

ggplot() +
  geom_point(data = GDP_diabetes_cal, aes(x = gdp_per_person, y = proportion_carbs), color = "purple") +
  geom_smooth(mapping = aes(x = GDP_diabetes_cal$gdp_per_person, y=GDP_diabetes_cal$proportion_carbs), color = "purple", method = "lm") +
  labs(x = "GDP per capita", y= "Calories from carbs")

ggplot() +
  geom_point(data = GDP_diabetes_cal, aes(x = gdp_per_person, y = proportion_animal_prot), color = "red") +  
  geom_smooth(mapping = aes(x = GDP_diabetes_cal$gdp_per_person, y=GDP_diabetes_cal$proportion_animal_prot), color = "red", method = "lm") +
  labs(x = "GDP per capita", y= "Calories from animal protein")

ggplot() +
  geom_point(data = GDP_diabetes_cal, aes(x = gdp_per_person, y = proportion_plant_prot), color = "green") +
  geom_smooth(mapping = aes(x = GDP_diabetes_cal$gdp_per_person, y=GDP_diabetes_cal$proportion_plant_prot), color = "green", method = "lm") +
  labs(x = "GDP per capita", y= "Calories from plant protein")
```



### 4.How do these differences relate to the diabetes prevalence in these countries ? What is the typical diet that can be observed in richer states that relates to lower diabetes prevalence ?

What we observed in the EDA seemed to not make sense as we were expecting a positive relationship between the total calories/calories consumed from fat and diabetes prevalence in a country. Let's see now concretely if there is any correlation between the calories consumed from different macronutrients and the diabetes rate.

```{r}
cor(GDP_diabetes_cal$prop_men_diabetes,GDP_diabetes_cal$cal_prot_animal)
cor(GDP_diabetes_cal$prop_women_diabetes,GDP_diabetes_cal$cal_prot_animal)
cor(GDP_diabetes_cal$prop_men_diabetes,GDP_diabetes_cal$cal_prot_plant)
cor(GDP_diabetes_cal$prop_women_diabetes,GDP_diabetes_cal$cal_prot_plant)
cor(GDP_diabetes_cal$prop_men_diabetes,GDP_diabetes_cal$cal_carbs)
cor(GDP_diabetes_cal$prop_women_diabetes,GDP_diabetes_cal$cal_carbs)
cor(GDP_diabetes_cal$prop_men_diabetes,GDP_diabetes_cal$cal_fat)
cor(GDP_diabetes_cal$prop_women_diabetes,GDP_diabetes_cal$cal_fat)

lm_diabetes_men_cal_prot_animal <- lm(GDP_diabetes_cal$prop_men_diabetes ~ GDP_diabetes_cal$cal_prot_animal)
lm_diabetes_women_cal_prot_animal <- lm(GDP_diabetes_cal$prop_women_diabetes ~ GDP_diabetes_cal$cal_prot_animal)
lm_diabetes_men_cal_prot_plant <- lm(GDP_diabetes_cal$prop_men_diabetes ~ GDP_diabetes_cal$cal_prot_plant)
lm_diabetes_women_cal_prot_plant <- lm(GDP_diabetes_cal$prop_women_diabetes ~ GDP_diabetes_cal$cal_prot_plant)
lm_diabetes_men_cal_carbs <- lm(GDP_diabetes_cal$prop_men_diabetes ~ GDP_diabetes_cal$cal_carbs)
lm_diabetes_women_cal_carbs <- lm(GDP_diabetes_cal$prop_women_diabetes ~ GDP_diabetes_cal$cal_carbs)
lm_diabetes_men_cal_fat <- lm(GDP_diabetes_cal$prop_men_diabetes ~ GDP_diabetes_cal$cal_fat)
lm_diabetes_women_cal_fat <- lm(GDP_diabetes_cal$prop_women_diabetes ~ GDP_diabetes_cal$cal_fat)

kable(prettify(summary(lm_diabetes_men_cal_prot_animal)))
kable(prettify(summary(lm_diabetes_women_cal_prot_animal)))
kable(prettify(summary(lm_diabetes_men_cal_prot_plant)))
kable(prettify(summary(lm_diabetes_women_cal_prot_plant)))
kable(prettify(summary(lm_diabetes_men_cal_carbs)))
kable(prettify(summary(lm_diabetes_women_cal_carbs)))
kable(prettify(summary(lm_diabetes_men_cal_fat)))
kable(prettify(summary(lm_diabetes_women_cal_fat)))

#proportions
cor(GDP_diabetes_cal$prop_men_diabetes,GDP_diabetes_cal$proportion_animal_prot)
cor(GDP_diabetes_cal$prop_women_diabetes,GDP_diabetes_cal$proportion_animal_prot)
cor(GDP_diabetes_cal$prop_men_diabetes,GDP_diabetes_cal$proportion_plant_prot)
cor(GDP_diabetes_cal$prop_women_diabetes,GDP_diabetes_cal$proportion_plant_prot)
cor(GDP_diabetes_cal$prop_men_diabetes,GDP_diabetes_cal$proportion_carbs)
cor(GDP_diabetes_cal$prop_women_diabetes,GDP_diabetes_cal$proportion_carbs)
cor(GDP_diabetes_cal$prop_men_diabetes,GDP_diabetes_cal$proportion_fat)
cor(GDP_diabetes_cal$prop_women_diabetes,GDP_diabetes_cal$proportion_fat)

lm_diabetes_men_prop_prot_animal <- lm(GDP_diabetes_cal$prop_men_diabetes ~ GDP_diabetes_cal$proportion_animal_prot)
lm_diabetes_women_prop_prot_animal <- lm(GDP_diabetes_cal$prop_women_diabetes ~ GDP_diabetes_cal$proportion_animal_prot)
lm_diabetes_men_prop_prot_plant <- lm(GDP_diabetes_cal$prop_men_diabetes ~ GDP_diabetes_cal$proportion_plant_prot)
lm_diabetes_women_prop_prot_plant <- lm(GDP_diabetes_cal$prop_women_diabetes ~ GDP_diabetes_cal$proportion_plant_prot)
lm_diabetes_men_prop_carbs <- lm(GDP_diabetes_cal$prop_men_diabetes ~ GDP_diabetes_cal$proportion_carbs)
lm_diabetes_women_prop_carbs <- lm(GDP_diabetes_cal$prop_women_diabetes ~ GDP_diabetes_cal$proportion_carbs)
lm_diabetes_men_prop_fat <- lm(GDP_diabetes_cal$prop_men_diabetes ~ GDP_diabetes_cal$proportion_fat)
lm_diabetes_women_prop_fat <- lm(GDP_diabetes_cal$prop_women_diabetes ~ GDP_diabetes_cal$proportion_fat)

kable(prettify(summary(lm_diabetes_men_prop_prot_animal)))
kable(prettify(summary(lm_diabetes_women_prop_prot_animal)))
kable(prettify(summary(lm_diabetes_men_prop_prot_plant)))
kable(prettify(summary(lm_diabetes_women_prop_prot_plant)))
kable(prettify(summary(lm_diabetes_men_prop_carbs)))
kable(prettify(summary(lm_diabetes_women_prop_carbs)))
kable(prettify(summary(lm_diabetes_men_prop_fat)))
kable(prettify(summary(lm_diabetes_women_prop_fat)))
```

