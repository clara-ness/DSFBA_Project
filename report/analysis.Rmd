# Analysis

```{r, echo = FALSE, message = FALSE}
source(here::here("scripts/setup.R"))
```

* Answers to the research questions
* Different methods considered
* Competing approaches
* Justifications

### 1.Do European countries that have higher GDPs really have lower diabetes prevalence ?

This first question serves more as a control, since we learned during our research prior to our project that countries with higher GDPs tend to have lower diabetes rates. Indeed, we can observe that in the EDA. 

It is important to note that, when we try to fit a linear model on these variables and observe correlations over all observations, we see that these relationships are not significant at all.

```{r}
#with outliers
cor(GDP_diabetes_cal$avg_gdp, GDP_diabetes_cal$prop_women_diabetes)
cor(GDP_diabetes_cal$avg_gdp, GDP_diabetes_cal$prop_men_diabetes)

lm_gdp_diabetes_women <- lm(GDP_diabetes_cal$avg_gdp ~ GDP_diabetes_cal$prop_women_diabetes)

lm_gdp_diabetes_men <- lm(GDP_diabetes_cal$avg_gdp ~ GDP_diabetes_cal$prop_men_diabetes)


kable(prettify(summary(lm_gdp_diabetes_men)))
```

However, once we exclude outliers, we see that the relationship is way more significant !

```{r}
#without outliers
cor(GDP_diabetes_cal2$avg_gdp, GDP_diabetes_cal2$prop_women_diabetes)
cor(GDP_diabetes_cal2$avg_gdp, GDP_diabetes_cal2$prop_men_diabetes)

lm_gdp_diabetes_women2 <- lm(GDP_diabetes_cal2$avg_gdp ~ GDP_diabetes_cal2$prop_women_diabetes)

lm_gdp_diabetes_men2 <- lm(GDP_diabetes_cal2$avg_gdp ~ GDP_diabetes_cal2$prop_men_diabetes)

kable(prettify(summary(lm_gdp_diabetes_women2)))
kable(prettify(summary(lm_gdp_diabetes_men2)))
```

#### LOOK SPECIFICALLY INTO RICH COUNTRIES ?

### 2.Do European countries that have higher GDPs consume less calories ?

As mentioned in the first point, countries with a higher GDP have a lower diabetes rate which could potentially be explained by the consumption of fewer calories.

But is there a real correlation between these two variables ? Let's check :

```{r}
cor(GDP_diabetes_cal$avg_gdp,GDP_diabetes_cal$total_consumption)

lm_gdp_total_cal <- lm(GDP_diabetes_cal$avg_gdp ~ GDP_diabetes_cal$total_consumption)

kable(prettify(summary(lm_gdp_total_cal)))
```


Neither the correlation between these two variables nor the linear regression is significant. However, it would be interesting to look further.  To do this we can use the clustering method. To determine the number of clusters we use the elbow method. This method examines the percentage of variance explained as a function of the number of clusters. It is based on the idea that a number of clusters should be chosen such that the addition of another cluster does not allow for a better modeling of the data. The percentage of variance explained by the clusters is plotted against the number of clusters.

```{r}
data_1 <- GDP_diabetes_cal[,-(1:2),drop=FALSE] 
rownames(data_1) <- c("AUT", "BEL", "BGR", "HRV", "CYP", "CZE", "DNK", "EST", "FIN", "FRA", "DEU","GRC", "HUN", "IRL", "ITA", "LVA", "LTU", "LUX", "MLT", "NLD", "POL", "PRT", "ROU", "SVK", "SVN", "ESP", "SWE", "GBR", "CHE")

fviz_nbclust(data_1, kmeans, method = "wss") +
  geom_vline(xintercept = 2, linetype = 2) + # add line for better visualisation
  labs(subtitle = "Elbow method") # add subtitle

```

We therefore see from the graph above that the optimal number of clusters is 2. The allocation of countries according to their cluster is therefore as follows:

```{r}

res_kmeans <- cluster_analysis(data_1,
                 n = 2,
                 method = "kmeans")

predict(res_kmeans) # get clusters

myCluster <- data.frame(row.names(data_1), res_kmeans)


cluster_1<- myCluster %>%
  group_by(res_kmeans)

  
kable(myCluster, col.names = c("Country","Cluster"))

```

To get a better idea of the difference between the clusters, we will plot the means of each dimension in each group:

```{r}
plot(res_kmeans)
```
We can therefore see that diabetes is indeed lower in the first cluster which is the countries with the highest GPD. However, in terms of total calorie intake it is also the first cluster that consumes the most calories. One might therefore think that calorie consumption is not the main reason why high-GDP countries have lower diabetes rates.
Nevertheless, we found it interesting to try to make 3 clusters to see the difference in total calorie consumption compared to the GDP rate.
```{r}
model_cluster <- kmeans(data_1, centers = 3, nstart = 10)

# displays the class determined by
# the model for all observations:
kable(model_cluster$cluster,  col.names = c("Cluster"))

Data_cluster <- data.frame(data_1,
  cluster = as.factor(model_cluster$cluster)
)

```
We then plot those 3 clusters to see the differences: 
```{r}
res_kmeans_3 <- cluster_analysis(data_1,
                 n = 3,
                 method = "kmeans")

predict(res_kmeans_3) # get clusters
kable(res_kmeans_3)

```

The table shows that there is a better distribution of GDP, we will again make a graph to compare the differences between the clusters.
```{r}
plot(res_kmeans_3)
```
Oddly enough, it seems that a higher consumption of animal protein could be related to the rate of diabetes, which would be counter-intuitive to M. Adeva-Andany's (2019) article "Dietary habits contribute to define the risk of type 2 diabetes in humans". We are going to investigate this very issue of calorie consumption patterns that could be related to low diabetes rates. 


```{r}
#trying to plot the consumption patterns
#library(plotly)
#library(dplyr)

#donut<- data.frame(GDP_diabetes_cal , cat=c("cal_prot_animal", "cal_carbs", "cal_prot_plant", "cal_fat"))

#GDP_diabetes_cal$total_consumption <- sapply(strsplit(rownames(GDP_diabetes_cal), " "), "[[", 1)

#donut <- donut %>% group_by(cat)
#donut <- donut %>% summarize(count = n())
#fig <- donut %>% plot_ly(labels = ~cat, values = ~count)
#fig <- fig %>% add_pie(hole = 0.6)
#fig <- fig %>% layout(title = "Donut charts to show consumption patterns",  showlegend = F,
                     # xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
                     # yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

#fig

```



### 3.How do the macronutrients (animal protein/plant protein/fat/carbohydrates) consumed differ between richer and poorer countries ?

We observed during the EDA that richer countries seemed to consume more fat on average. Now we want to see if we can confirm this relationship, and observe if there isn't a correlation between the average GDP of a country and the consumption of other macronutrients too.

```{r}
cor(GDP_diabetes_cal$avg_gdp,GDP_diabetes_cal$cal_prot_animal)
cor(GDP_diabetes_cal$avg_gdp,GDP_diabetes_cal$cal_prot_plant)
cor(GDP_diabetes_cal$avg_gdp,GDP_diabetes_cal$cal_carbs)
cor(GDP_diabetes_cal$avg_gdp,GDP_diabetes_cal$cal_fat)


lm_gdp_cal_prot_animal <- lm(GDP_diabetes_cal$avg_gdp ~ GDP_diabetes_cal$cal_prot_animal)
lm_gdp_cal_prot_plant <- lm(GDP_diabetes_cal$avg_gdp ~ GDP_diabetes_cal$cal_prot_plant)
lm_gdp_cal_carbs <- lm(GDP_diabetes_cal$avg_gdp ~ GDP_diabetes_cal$cal_carbs)
lm_gdp_cal_fat <- lm(GDP_diabetes_cal$avg_gdp ~ GDP_diabetes_cal$cal_fat)

kable(prettify(summary(lm_gdp_cal_prot_animal)))
kable(prettify(summary(lm_gdp_cal_prot_plant)))
kable(prettify(summary(lm_gdp_cal_carbs)))
kable(prettify(summary(lm_gdp_cal_fat)))


################################
ggplot() + 
  geom_line(data = GDP_diabetes_cal, aes(x = gdp_per_person, y = total_consumption), color = "orange") +
  geom_smooth(mapping = aes(x = GDP_diabetes_cal$gdp_per_person, y=GDP_diabetes_cal$total_consumption), color = "orange", method = "lm") +
  labs(x = "GDP per capita", y= "Calories")

ggplot() + 
  geom_line(data = GDP_diabetes_cal, aes(x = gdp_per_person, y = cal_fat), color = "blue") +
  geom_smooth(mapping = aes(x = GDP_diabetes_cal$gdp_per_person, y=GDP_diabetes_cal$cal_fat), color = "blue", method = "lm") +
  labs(x = "GDP per capita", y= "Calories from fat")

ggplot() +
  geom_line(data = GDP_diabetes_cal, aes(x = gdp_per_person, y = cal_carbs), color = "purple") +
  geom_smooth(mapping = aes(x = GDP_diabetes_cal$gdp_per_person, y=GDP_diabetes_cal$cal_carbs), color = "purple", method = "lm") +
  labs(x = "GDP per capita", y= "Calories from carbs")

ggplot() +
  geom_line(data = GDP_diabetes_cal, aes(x = gdp_per_person, y = cal_prot_animal), color = "red") +  
  geom_smooth(mapping = aes(x = GDP_diabetes_cal$gdp_per_person, y=GDP_diabetes_cal$cal_prot_animal), color = "red", method = "lm") +
  labs(x = "GDP per capita", y= "Calories from animal protein")

ggplot() +
  geom_line(data = GDP_diabetes_cal, aes(x = gdp_per_person, y = cal_prot_plant), color = "green") +
  geom_smooth(mapping = aes(x = GDP_diabetes_cal$gdp_per_person, y=GDP_diabetes_cal$cal_prot_plant), color = "green", method = "lm") +
  labs(x = "GDP per capita", y= "Calories from plant protein")

```

The relationship between the average GDP of a country and the calories consumed from fat per person is therefore not as significant as we may have thought. For other macronutriments, there seems to be no correlation at all.

Another way to answer this research question can be to see the relationship between the wealth of a country and the proportions of the total calories consumed dedicated to each macronutrient.

```{r}
GDP_diabetes_cal <- mutate(GDP_diabetes_cal, proportion_animal_prot = cal_prot_animal/total_consumption, proportion_plant_prot = cal_prot_plant/total_consumption, proportion_carbs = cal_carbs/total_consumption, proportion_fat = cal_fat/total_consumption)

cor(GDP_diabetes_cal$avg_gdp,GDP_diabetes_cal$proportion_animal_prot)
cor(GDP_diabetes_cal$avg_gdp,GDP_diabetes_cal$proportion_plant_prot)
cor(GDP_diabetes_cal$avg_gdp,GDP_diabetes_cal$proportion_carbs)
cor(GDP_diabetes_cal$avg_gdp,GDP_diabetes_cal$proportion_fat)

lm_gdp_prop_animal_prot <- lm(GDP_diabetes_cal$avg_gdp ~ GDP_diabetes_cal$proportion_animal_prot)
lm_gdp_prop_plant_prot <- lm(GDP_diabetes_cal$avg_gdp ~ GDP_diabetes_cal$proportion_plant_prot)
lm_gdp_prop_carbs <- lm(GDP_diabetes_cal$avg_gdp ~ GDP_diabetes_cal$proportion_carbs)
lm_gdp_prop_fat <- lm(GDP_diabetes_cal$avg_gdp ~ GDP_diabetes_cal$proportion_fat)

kable(prettify(summary(lm_gdp_prop_animal_prot)))
kable(prettify(summary(lm_gdp_prop_plant_prot)))
kable(prettify(summary(lm_gdp_prop_carbs)))
kable(prettify(summary(lm_gdp_prop_fat)))
```

With proportions, correlation is higher than with calorie count and linear regression parameters a bit more significant but the relationships are still not strong enough.

-top 5, last 5 ?


### 4.How do these differences relate to the diabetes prevalence in these countries ? What is the typical diet that can be observed in richer states that relates to lower diabetes prevalence ?

