# Exploratory data analysis

```{r, echo = FALSE, message = FALSE}
source(here::here("scripts/setup.R"))
```

* Mapping out the underlying structure
* Identifying the most important variables
* Univariate visualizations
* Multivariate visualizations
* Summary tables

First, even though we will be taking the means of the variables with which we are trying to answer our questions, it is interesting to observe their evolution in each country over time. We started with the GDP.

## GDP per country

```{r}
ggplot(data = GDP) +
  geom_point(mapping = aes(x = year, y = avg_gdp)) +
  facet_wrap(~ country_name, nrow = 4)
```


## Plotting GDP against Diabetes (Men & Women)
```{r}
#since there are diabetes for men and women i am not sure the coloring on this graph is entirely correct
ggplot(data = GDP_diabetes_cal) +
  geom_point(mapping = aes(x = avg_gdp, y = prop_men_diabetes, color = "blue")) +
  geom_point(mapping = aes(x = avg_gdp, y = prop_women_diabetes, color = "red"))
```

However, we see that apart of 5 outliers, our observations are mostly bunched up at the left of the graph. We decided to exclude these 5 observations, to see if we can observe a trend with the other countries. These outliers, as observed in the graph before, are the countries that had a big increase of GDP in the time period of 2000-2013.

```{r}
GDP_no_outlier <- arrange(GDP_summarized, desc(GDP_summarized$avg_gdp))
GDP_no_outlier <- GDP_no_outlier[-c(1:5),]

GDP_diabetes_cal2 <- left_join(GDP_no_outlier,Diabetes_EU_men, by="country_code")
GDP_diabetes_cal2 <- left_join(GDP_diabetes_cal2,Diabetes_EU_women, by="country_code")
GDP_diabetes_cal2 <- left_join(GDP_diabetes_cal2,Caloric_consumption, by="country_code")

#since there are diabetes for men and women i am not sure the coloring on this graph is entirely correct
ggplot(data = GDP_diabetes_cal2) +
  geom_point(mapping = aes(x = avg_gdp, y = prop_men_diabetes, color = "blue")) +
  geom_smooth(mapping = aes(x = avg_gdp, y = prop_men_diabetes, color = "blue"), method = "lm") +
  geom_point(mapping = aes(x = avg_gdp, y = prop_women_diabetes, color = "red")) +
  geom_smooth(mapping = aes(x = avg_gdp, y = prop_women_diabetes, color = "red"), method = "lm")
```

Without the outliers, we can see a bit more clearly. Indeed, it seems that the richer a country is, the lesser it has a high diabetes rate among its population. But what about the 5 most rich countries in Europe ?



## Evolution of calories in each countries

First, we tried to see if there was a trend in the consumption of macro-nutrients in the 2000s for each country in our sample by plotting those evolution over time:
```{r}
#Plotting the evolution of the micronutrients consumption over the years for each country

cal_unique <- unique(daily_caloric, by =c('Entity')) # Sorting table by entity (unique)

for (i in 1:nrow(cal_unique)) { # Loop for each entity 
tmp <- cal_unique$Entity[i]     # Getting the entity name i

# Taking subset of data table for the chosen entity i 
tmp <- subset(daily_caloric,Entity == tmp, select = c("Year","Calories from animal protein (FAO (2017))",
                                                            "Calories from plant protein (FAO (2017))",
                                                            "Calories from fat (FAO (2017))",
                                                            "Calories from carbohydrates (FAO (2017))"))

# Melting the data by years (i.e. getting each value for the different rows for each years) 
tmp <- melt(tmp ,  id.vars = 'Year', variable.name = 'Series')

# Print plot
print(ggplot(tmp, aes(Year,value)) + geom_line(aes(colour = Series),size = 2) +
  labs(title = paste("Caloric consumption per year",cal_unique$Entity[i]),
       y = "Value", x = "Year"))
  
}
```

There do not seem to be any trends in the graphs above and diets are rather stable in each country, which is why we will take the average consumption for each macro-nutrient. We can however note that the 5 outliers mentioned before have a higher fat consumption than the countries with a smaller GDP. 

## GDP againt total calories

We now plot the different consumption and the total consumption of each macro-nutrients to see if there's a trend:

```{r}
#Plotting different cal consumption with GDP (trying to find a trend)
plot(GDP_diabetes_cal$avg_gdp, GDP_diabetes_cal$total_consumption,
main="Caloric consumption by country",
ylab="",
type="p",
col="blue")
lines(GDP_diabetes_cal$avg_gdp,GDP_diabetes_cal$cal_fat, col="red", type="p")
lines(GDP_diabetes_cal$avg_gdp,GDP_diabetes_cal$cal_carbs, col="green", type="p")
lines(GDP_diabetes_cal$avg_gdp,GDP_diabetes_cal$cal_prot_animal, col="orange", type="p")
lines(GDP_diabetes_cal$avg_gdp,GDP_diabetes_cal$cal_prot_plant, col="purple", type="p")
legend("topleft", c("Total Tonsumption","Fat", "Carbs", "Animal Protein", "Plant Protein"),
fill=c("blue","red", "green", "orange", "purple"))
```

We thus see that total consumption is higher in countries with higher GDP, which may indicate a positive correlation.
To better understand this trend, we plot total consumption with the GDP of countries.

```{r}
#ggplot total consumption against GDP
ggplot(GDP_diabetes_cal, aes(x=GDP_diabetes_cal$avg_gdp, y=GDP_diabetes_cal$total_consumption)) +
  geom_point() + # Show dots
  geom_text(
    label= (GDP_diabetes_cal$country_code),  
    nudge_x = 0.25, nudge_y = 0.25, 
    check_overlap = T)+
  geom_smooth(mapping = aes(x = GDP_diabetes_cal$avg_gdp, y=GDP_diabetes_cal$total_consumption, color = "red"), method = "lm")
```
We always end up with these 5 outliers that have a higher than average GDP so if we remove them from the average we have:

```{r}
ggplot(GDP_diabetes_cal2, aes(x=GDP_diabetes_cal2$avg_gdp, y=GDP_diabetes_cal2$total_consumption)) +
  geom_point() + # Show dots
  geom_text(
    label= (GDP_diabetes_cal2$country_code),  
    nudge_x = 0.25, nudge_y = 0.25, 
    check_overlap = T)+
geom_smooth(mapping = aes(x = GDP_diabetes_cal2$avg_gdp, y=GDP_diabetes_cal2$total_consumption, color = "red"), method = "lm")
```
Now we can see clearly that there's a trend.

```{r}
#ggplot total consumption against Diabetes
ggplot(GDP_diabetes_cal, aes(x=GDP_diabetes_cal$prop_men_diabetes, y=GDP_diabetes_cal$total_consumption)) +
  geom_point() + # Show dots
  geom_text(
    label= (GDP_diabetes_cal$country_code),  
    nudge_x = 0.5, nudge_y = 0.5, 
    check_overlap = T)

##the last 2 plots not the same distributions!! so Question 1 not so trivial after all
ggplot(data = GDP_diabetes_cal, mapping = aes(x = country_code, y = total_consumption, color = as.factor("country_name"))) + geom_point()

#ranking GDP and total consumption 
GDP_diabetes_cal$rank_GDP <- rank(GDP_diabetes_cal$avg_gdp)
GDP_diabetes_cal$rank_Consumption <- rank(GDP_diabetes_cal$total_consumption)


#Rank btw them 
#GDP_diabetes_cal <-within(GDP_diabetes_cal, rank3 <- rank(order(rank_GDP, rank_Consumption), ties.method='first'))
#order_by(rank3)
#not the same so ranking maybe link btw regimes and lowest diabetes rates??
  

```




#Diabetes againt calories Fabien

```{r}
plot(GDP_diabetes_cal$cal_carbs,GDP_diabetes_cal$prop_men_diabetes)
plot(GDP_diabetes_cal$total_consumption,GDP_diabetes_cal$prop_women_diabetes)
ggplot(data = GDP_diabetes_cal) +
  geom_smooth(mapping = aes(x = total_consumption, y = prop_men_diabetes))

#plotting the evolution of the prevalence of diabetes for each country 
Diabetes_EU <- Diabetes_EU[-c(2)]
Diabetes_unique <- unique(Diabetes_EU[c('country')]) # Sorting table by country (unique)

for (i in 1:nrow(Diabetes_unique)) { 
tmp <- Diabetes_unique$country[i]     

# Taking subset of data table for the chosen country i 
tmp2 <- subset(Diabetes_EU,country == tmp, select = c("sex","year","prop_diabetes"))

# Print plot
print(ggplot(data = tmp2, mapping = aes(x = year, y =prop_diabetes, color =sex)) + geom_line()
  + labs(title = paste("Evolution of diabetes prevalence in",tmp)))
}
```
